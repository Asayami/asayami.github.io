<!DOCTYPE html>
<html>
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-3NTSMWGK5D"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-3NTSMWGK5D");
    </script>
    <meta charset="UTF-8" />
    <title>Windows OS</title>
    <link
      rel="icon"
      type="image/png"
      href="https://asayami.github.io/favicon.png"
    />
    <link
      rel="stylesheet"
      href="https://asayami.github.io/theme/notebook.css"
    />
    <link rel="stylesheet" href="https://asayami.github.io/theme/theme.css" />
    <script src="https://asayami.github.io/theme/notebook.js"></script>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    <meta
      name="description"
      content="Những bài viết, kinh nghiệm của mình về windows và malware"
    />
    <meta
      name="keywords"
      content="Hacking, hack, malware, virus, assembly, windows"
    />
    <meta name="author" content="Asayami Kurashin" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <div id="themeSpace"></div>
    <script>
      loadNavbar();
    </script>

    <img class="mainPicture" src="malware_source/win-10-bsod.jpg" />
    <div class="paragraph">
      <h3>Introduction</h3>
      <p>
        Microsoft Windows (Windows) là một họ hệ điều hành dựa trên giao diện
        người dùng đồ hoạ được phát triển và được phân phối bởi Microsoft. Nó
        bao gồm một vài các dòng hệ điều hành, mỗi trong số đó phục vụ một phần
        nhất định của ngành công nghiệp máy tính. Các dòng Windows hiện tại gồm
        Windows NT, Windows Embedded Compact và Windows Phone; chúng có thể bao
        gồm các phân họ, ví dụ như Windows Embedded Compact (Windows CE) hoặc
        Windows Server. Các dòng gia đình Windows đã bị ngừng gồm Windows 9x,
        Windows Mobile và Windows Phone.
      </p>
      <p>Windows OS evolution:</p>
      <img
        src="malware_source/evolution-of-the-windows-operating-system.jpg"
        style="width: 55%"
        class="img-fluid mx-auto d-block responsive_phone"
      />
      <p>
        <br />Trong bài viết này mình sẽ giới thiệu các khái niệm về Windows
        liên quan tới việc viết & phân tích malware.
      </p>
    </div>
    <div class="paratitle">
      <h2>Related tools</h2>
    </div>
    <div class="paragraph">
      <p>
        Một số tool phổ biến mà mình sử dụng khi phân tích malware trên Windows:
        <br />&emsp;- PEiD: Phần mềm dùng để detect packer của file exe.
        <br />&emsp;- IDA Pro: Disassembler, decompiler. <br />&emsp;- Detect It
        Easy: Dùng để detect packer, compiler, thông tin file exe,... (best).
        <br />&emsp;- Resource Hacker: Dùng để extract resource từ file exe.
      </p>
    </div>

    <div class="paratitle">
      <h2>Common DLLs</h2>
    </div>
    <div class="paragraph">
      <h3>kernel32.dll</h3>
      <p>
        Kernel32.dll là một trong những file DLL thực hiện tính năng quan trọng
        như quản lí và phân bổ memory, files và phần cứng.
      </p>
      <h3>advapi32.dll</h3>
      <p>
        Advapi32.dll chứa các hàm liên quan đến security, registry, event log,
        service control manager, và file system.
      </p>
      <h3>user32.dll</h3>
      <p>
        User32.dll chứa các hàm liên quan đến giao diện người dùng như tạo cửa
        sổ, xử lí message, và các hàm liên quan đến các control.
      </p>
      <h3>gdi32.dll</h3>
      <p>
        Gdi32.dll chứa các hàm liên quan đến graphic device interface như vẽ
        hình, text, và các hàm liên quan đến font.
      </p>
      <h3>ntdll.dll</h3>
      <p>
        Ntdll.dll chứa các hàm liên quan đến kernel mode như memory management,
        process và thread management, và các hàm liên quan đến system.
      </p>
      <h3>wsock32.dll và ws2_32.dll</h3>
      <p>
        Wsock32.dll và ws2_32.dll chứa các hàm liên quan đến network như socket
        và các hàm liên quan đến network.
      </p>
      <h3>wininet.dll</h3>
      <p>
        Wininet.dll chứa các hàm liên quan đến internet như http, ftp, và các
        hàm liên quan đến internet.
      </p>
    </div>

    <div class="paratitle">
      <h2>Running DLLs</h2>
    </div>
    <div class="paragraph">
      <p>
        Đối với file .exe, chúng ta có thể dễ dàng chạy bằng cách double click.
        Nhưng đối với file DLL thì khác. Thông thường chúng ta sẽ cần một file
        exe khác để chạy file DLL đó. Một cách khác để chạy file DLL là thông
        qua rundll32.exe. Ví dụ, để chạy file DLL có tên là ProjectMeow.dll với
        hàm export là HelloWorld, chúng ta có thể sử dụng lệnh sau trong cmd.
      </p>
      <pre><a style="color: #009933;"><code>
  rundll32.exe ProjectMeow.dll, HelloWorld
      </code></a></pre>
      <img
        src="malware_source/dllcreate.png"
        style="margin-bottom: 2rem; width: 70%"
        class="img-fluid mx-auto d-block responsive_phone"
      />
      <p>
        Thay vì gọi hàm bằng tên cũng có thể gọi qua ordinal của hàm đó, ví dụ
        thay HelloWorld ở lệnh trên bằng #5.
      </p>
      <p>
        Lưu ý rằng không phải file DLL nào cũng có thể sử dụng rundll32 để chạy.
        Nếu file DLL export ra class thay vì function thì không thể chạy bằng
        rundll32.
      </p>
    </div>

    <div class="paratitle">
      <h2>Function Naming Conventions</h2>
    </div>
    <div class="paragraph">
      <p>
        Khi đọc tên các hàm của Windows, có thể ở đầu hay cuối tên sẽ có một số
        kí tự đặc biệt dễ gây lú. Ví dụ, nếu một hàm có hậu tố Ex
        (CreateWindowEx), điều đó có nghĩa là hàm đó là một phiên bản mở rộng
        của hàm gốc (ví dụ như CreateWindow) mà không tương thích với phiên bản
        cũ đó nữa. Nếu được cải tiến 2 lần thì hậu tố Ex sẽ được lặp lại 2 lần.
        <br />Hay nếu hàm có hậu tố W hay A (CreateDirectoryW), chữ cái này thể
        hiện kiểu dữ liệu của tham số string mà hàm đó nhận. W thể hiện kiểu dữ
        liệu wide string (2 bytes cho mỗi kí tự), còn A thể hiện kiểu dữ liệu
        ansi string (1 byte cho mỗi kí tự). Ansi là bản mở rộng của ASCII với
        thêm 128 kí tự (8 bit vs 7 bit).
      </p>
    </div>
    <div class="paratitle">
      <h2>PE File Structure</h2>
    </div>
    <div class="paragraph">
      <p>
        Về cấu trúc của file PE, mình đã giới thiệu trong bài viết
        <a href="https://asayami.github.io/hacking/re/re-1.html"
          >Reverse Engineering Overview</a
        >. Khi phân tích một file PE, bước đầu tiên mình sẽ ném nó vào DIE để
        xem thông tin cơ bản. DIE (hay Detect It Easy) là một công cụ rất tốt để
        detect packer, compiler, và xem các thông tin cơ bản của file exe. Mình
        cũng có thể dễ dàng ném file lên VirusTotal để test một cách nhanh
        chóng. <br /><br />
        <img
          src="malware_source/die.png"
          style="width: 70%"
          class="img-fluid mx-auto d-block responsive_phone"
        />
      </p>
      <p>
        Như trên ảnh là thông tin các section của một file PE không bị packed.
        Dù DIE có thể detect file có bị packed hay không, chúng ta vẫn có thể dễ
        dàng thấy điều đó dựa vào những thông tin về section. Ví dụ section
        .text, .data,... có raw size là 0 mà virtual size (virtual size là kích
        thước khi section biến thành segment trong bộ nhớ) lại lớn, hay xuất
        hiện những section có tên kì lạ như .abcxyz.
      </p>
      <p>
        Bên cạnh đó, còn có section .rsrc chứa các resource như icon, bitmap,
        string,... Mình có thể dùng Resource Hacker để extract các resource đó.
        Có những trường hợp malware hay kể cả các ứng dụng bình thường sẽ giấu
        file hay driver vào resource. Resource Hacker cũng giúp mình trích xuất
        những thứ đó.
      </p>
    </div>
  </body>
</html>
